variables:
  APK_NAME: Minds.apk

include:
  - local: .gitlab/ci/test.yml
  - local: .gitlab/ci/pushrelease.yml
  - local: .gitlab/ci/build.yml
  - local: .gitlab/ci/upload.yml
  - local: .gitlab/ci/release.yml
  - local: .gitlab/ci/maintenance.yml
  - local: .gitlab/ci/qa.yml

stages:
  - test
  - pushrelease
  - build
  - upload
  - release
  - maintenance
  - qa

# Gets the version of the app parsing the gradle.properties file
.getversion:
  script:
    - 'export APPVERSION=`grep -o "^versionName=.*" android/gradle.properties | tr -d "versionName="`'

# Delete the build from browserstack
.delete_browserstack:
  script:
    - 'echo "Deleting browserstack credentials..."'
    - node tasks/deleteBrowserstackFile.js $TARGET_NAME

# Run only for tags that ends on .0 (major, minor releases)
.rule_nonpatch_release_manual:
  rules:
    - if: $CI_COMMIT_TAG =~ /.*\.0$/
      changes:
        - master
      when: manual

# Run only for tags that ends on .0 (major, minor releases)
.rule_nonpatch_release:
  rules:
    - if: $CI_COMMIT_TAG =~ /.*\.0$/
      changes:
        - master

# Run for tags that ends on .0 (major, minor releases)
.rule_nonpatch_release_success:
  rules:
    - if: $CI_COMMIT_TAG =~ /.*\.0$/
      changes:
        - master
      when: on_success

# Run only for tags that don't end on .0 (patch releases)
.rule_patch_release:
  rules:
    - if: $CI_COMMIT_TAG !~ /.*\.0$/ && $CI_COMMIT_TAG != null
      changes:
        - master

# Run only on master
.only_master:
  only:
    refs:
      - master

# Run only on tags
.only_tags:
  only:
    refs:
      - tags

# Run only on nightly jobs
.except_nightly:
  except:
    variables:
      - $CI_RC_NIGHTLY_TESTS == "true"
      - $CI_PROD_NIGHTLY_TESTS == "true"

# Run only on native branches
.only_native:
  only:
    refs:
      - /^native-*/

# Run automatic on develop branch and manually on master
.rule_automatic_develop_manual_master:
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual

# Run automatic on nonpatch versions and manually on patch versions
.rule_automatic_nonpatch_manual_patch:
  rules:
    - if: $CI_COMMIT_TAG =~ /.*\.0$/
      when: on_success
    - if: $CI_COMMIT_TAG !~ /.*\.0$/ && $CI_COMMIT_TAG != null
      when: manual

# Run automatic on develop only
.rule_automatic_develop:
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: on_success
